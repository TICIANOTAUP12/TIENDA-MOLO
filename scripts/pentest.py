import requests
import time

BASE = "https://localhost:8443/api"

def get_csrf(session):
    r = session.get(f"{BASE}/csrf", verify=False)
    r.raise_for_status()
    return r.json().get('csrf_token')

def brute_force_lockout(session, username):
    csrf = get_csrf(session)
    for i in range(6):
        r = session.post(f"{BASE}/auth/login", json={"username": username, "password": "wrong"}, headers={'X-CSRF-Token': csrf}, verify=False)
        print("Attempt", i+1, r.status_code, r.text[:120])

def test_csrf_required(session):
    r = session.post(f"{BASE}/whatsapp/click", json={"producto_id": "test"}, verify=False)
    print("CSRF missing status:", r.status_code)
    csrf = get_csrf(session)
    r2 = session.post(f"{BASE}/whatsapp/click", json={"producto_id": "test"}, headers={'X-CSRF-Token': csrf}, verify=False)
    print("CSRF present status:", r2.status_code)

if __name__ == '__main__':
    s = requests.Session()
    # WARNING: self-signed cert in dev; disable verification for demo
    try:
        test_csrf_required(s)
        brute_force_lockout(s, "admin")
    except Exception as e:
        print("Pentest error:", e)
